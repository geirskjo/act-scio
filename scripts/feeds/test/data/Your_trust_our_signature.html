<html>
    <head>
        <title>Your trust, our signature</title>
    </head>
    <body>
        <p>
        Written and researched by Mark Bregman and Rindert Kramer Sending signed phishing emails Every organisation, whatever its size, will encounter phishing emails sooner or later. While the number of phishing attacks is increasing every day, the way in which phishing is used within a cyber-attack has not changed: an attacker comes up with a scenario &#8230; <a href="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/" class="more-link">Continue reading <span class="screen-reader-text">Your trust, our&#160;signature</span> <span class="meta-nav">&#8594;</span></a>
        </p>
        <p><em>Written and researched by Mark Bregman and Rindert Kramer</em></p>
<h2>Sending signed phishing emails</h2>
<p>Every organisation, whatever its size, will encounter phishing emails sooner or later. While the number of phishing attacks is increasing every day, the way in which phishing is used within a cyber-attack has not changed: an attacker comes up with a scenario which looks credible enough to persuade the target to perform a certain action like opening an attachment or clicking on a link in the email. To avoid such attacks the IT or security team will tell users to check for certain things to avoid falling for these phishing emails. One of the recommendations is to check if the email is digitally signed with a valid certificate. However, in this blog, we present an attack that abuses this recommendation to regain the recipient’s trust in the sender.</p>
<h3>Traditional phishing</h3>
<p>Countless organizations have fallen victim to traditional phishing attacks where the attacker tries to obtain credentials or to infect a computer within the target network. Phishing is a safe way to obtain such footholds for an attacker. The attacker can just send the emails, sit back and wait for the targets to start clicking.</p>
<p>At Fox-IT we receive lots of requests to run simulated phishing attacks; so our team sends out hundreds of thousands of carefully crafted emails every year to clients to simulate phishing campaigns. Whether it’s a blanket campaign against the entire staff or a spear phishing one against targeted individuals, the big issue with phishing stays the same; we need to persuade one person to follow our instructions. We are looking for the weakest link. Sometimes that is easy, sometimes not so much. But an attacker has all the time in the world. If there is no success today, then maybe tomorrow, or the day after…<br />
To create security awareness among employees, IT or the security team will tell their users to take a close look at a wide variety of things upon receiving emails. Some say you have to check for spelling mistakes, others say you have to be careful when you receive an email that tries to force you to do something (“<em>Change your password immediately, or you will lose your files</em>”), or when something is promised (“<em>Please fill in this survey and enter the raffle to win a new iPhone</em>”).</p>
<h4>SPF records</h4>
<p>Some will tell their users to check the domain that sent the email. But others might argue that anyone can send an email from an arbitrary domain; what’s known as ‘email spoofing’.</p>
<p>Wikipedia defines this as:</p>
<blockquote><p>
  Email spoofing is the creation of email messages with a forged sender address. Because the core email protocols do not have any mechanism for authentication, it is common for spam and phishing emails to use such spoofing to mislead the recipient about the origin of the message.</p>
<p>  &#8212; Wikipedia <a href="https://en.wikipedia.org/wiki/Email_spoofing" rel="nofollow">https://en.wikipedia.org/wiki/Email_spoofing</a>
</p></blockquote>
<p>This means that an email originating from the domain “ fox-it.com ”, may not have been sent by an employee of Fox-IT. This can be mitigated by implementing Sender Policy Framework (SPF) records. In an SPF record you specify which email servers are allowed to send emails on behalf of your domain. If an email originating from the domain “ fox-it.com ” was not sent by the email server specified in the SPF record, the email message can be flagged as SPAM. By using SPF records you know that the email was sent by an authorized email server, SPF records however, do not disclose the authenticity of the sender. If a company has configured their SMTP server as an open relay server, users can send mail on another user’s behalf which will pass the SPF record check on the receivers end. There are other measures that can be used to identify legitimate mail servers to reduce phishing attacks, such as DKIM and DMARC, however, these are beyond the scope of this blogpost.</p>
<h3>What is a digital signature?</h3>
<p>To tackle the problem of email spoofing some organizations sign their emails with a digital signature. This can be added to an email to give the recipient the ability to validate the sender as well as the integrity of the email message.<br />
For now we’ll focus on the aspect of validating the sender rather than the message integrity aspect. When the email client receives a signed email, it will check the attached certificate to see who the subject of the certificate is (i.e.: &#8220;john.doe@fox-it.com &#8220;). The client will check if this matches the originating email-address. To verify the authenticity of the digital signature, the email client will also check if the certificate is issued (signed) by a reputable Certificate Authority (CA). If the certificate is signed by a trusted Certificate Authority, the receiving email client will tell the recipient that the email is signed using a valid certificate. Most email clients will in this case show a green checkmark or a red rosette, like the one in the image below.</p>
<p><img data-attachment-id="2352" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/6oqvhok/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png" data-orig-size="686,139" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="6oQvhoK" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png?w=686" class="alignnone size-full wp-image-2352" src="https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png?w=800" alt="6oQvhoK" srcset="https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png 686w, https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/6oQvhoK.png?w=300 300w" sizes="(max-width: 686px) 100vw, 686px"   /></p>
<p>By default there is a set of trusted Certificate Authorities in the Windows certificate store. With digital certificates, everything is based on trusting those third parties, the Certificate Authorities. So we trust that the Certificate Authorities in our Windows certificate store give out certificates only after verifying that the certificate subject (i.e.: &#8220;john@fox-it.com &#8220;) is who they say they are. If we receive a signed email with a certificate which is verified by one of the Certificate Authorities we trust, our systems will tell us that the origin of the email is trusted and validated.<br />
Obviously the opposite is also true. If you receive a signed email and the attached certificate is not signed by a Certificate Authority which is in the Windows certificate store, then the signature will be considered invalid. It is possible to attach a self-signed certificate to an email; in which case the email will be signed, but the receiving email client won’t be able to validate the authenticity of the received certificate and therefore will show a warning message to the recipient.</p>
<p><img data-attachment-id="2362" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/oxmunkt/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png" data-orig-size="368,228" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="OxmuNkt" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png?w=368" class="alignnone size-full wp-image-2362" src="https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png?w=800" alt="OxmuNkt" srcset="https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png 368w, https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/OxmuNkt.png?w=300 300w" sizes="(max-width: 368px) 100vw, 368px"   /></p>
<h3>Common misconception regarding email signing</h3>
<p>Some IT teams are pushing email signing as the Holy Grail to avoid being caught by a phishing email, because it verifies the sender. And if the sender is verified, we have nothing to worry about.</p>
<p>Unfortunately, the green checkmark or the red rosette which accompanies a validated email signature seems to stimulate the same behavior as we’ve seen with the green padlock accompanying HTTPS websites. Users see the green padlock in their browser and think that the website is absolutely safe. Similarly, they see the green checkmark or the red rosette and make the assumption that everything is safe: it’s a signed email with a valid certificate, the sender is verified, which means everything must be OK and that the email can’t be a phishing attack.</p>
<p>This may be true, if alice@fox-it.com sends you a signed email with a valid certificate: the sender really is Alice from Fox-IT, provided that the private key of the certificate is not compromised. But, if alice@fox-it.cm (notice the ‘.cm’ instead of ‘.com’) sends you a signed email with a valid certificate, that person can still be anyone. As long as that person has control over the domain ‘fox-it.cm’, they will be able to send signed emails from that domain. Because many users are told that the green checkmark or the red rosette protects against phishing, they may be caught off guard if they receive an email containing a valid certificate.</p>
<h3>Sending signed phishing emails</h3>
<p>At Fox-IT we’re always trying to innovate, meaning in this case that we’re looking for ways to make the phishing emails in our simulations more appealing to our client’s employees. Adding a valid certificate makes them look genuine and creates a sense of trust. So when running phishing simulations we use virtual private servers to do the job. For each simulation we setup a fresh server with the required configuration in order to deliver the best possible phishing email. To send out the emails, we’ve developed a Python script into which we can feed a template, some variables and a target list. Recently we’ve updated the script to include the ability to sign our phishing emails. This results in very convincing phishing emails. For example, in Microsoft Office Outlook one of our phishing emails would look like this:</p>
<p><img data-attachment-id="2353" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/8a9ounj/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png" data-orig-size="704,538" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="8A9oUnj" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png?w=704" class="alignnone size-full wp-image-2353" src="https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png?w=800" alt="8A9oUnj" srcset="https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png 704w, https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/8A9oUnj.png?w=300 300w" sizes="(max-width: 704px) 100vw, 704px"   /></p>
<p>This is not limited to Office Outlook only, it is working in other mail clients as well, such as Lotus Notes. Although Lotus Notes doesn’t have a red rosette to show the user that an email is digitally signed, there are some indicators which are present when reading a signed email. As you can see below, the digital signature does still add to the legitimate look of the phishing emails:</p>
<p><img data-attachment-id="2351" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/5flonbj/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png" data-orig-size="886,510" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="5floNBj" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=800" class="alignnone size-full wp-image-2351" src="https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=800" alt="5floNBj" srcset="https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=800 800w, https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=300 300w, https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png?w=768 768w, https://foxitsecurity.files.wordpress.com/2018/12/5floNBj.png 886w" sizes="(max-width: 800px) 100vw, 800px"   /></p>
<h3>Going the extra mile</h3>
<p>The user has now received a phishing mail that was signed with a legitimate certificate. To make it look even more genuine, we can mention the certificate in the phishing mail. Since the Dutch government has a webpage<sup>1</sup> with information about the use of electronic signatures in email, we can write a paragraph that looks something like the the one in the image below.</p>
<p><img data-attachment-id="2364" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/gov/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/gov.png" data-orig-size="670,251" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="gov" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/gov.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/gov.png?w=670" class="alignnone size-full wp-image-2364" src="https://foxitsecurity.files.wordpress.com/2018/12/gov.png?w=800" alt="gov" srcset="https://foxitsecurity.files.wordpress.com/2018/12/gov.png 670w, https://foxitsecurity.files.wordpress.com/2018/12/gov.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/gov.png?w=300 300w" sizes="(max-width: 670px) 100vw, 670px"   /></p>
<h3>Sign the email</h3>
<p>The following (Python) code snippet shows the main signing functionality:</p>
<pre class="brush: python; title: ; notranslate">
# Import the necessary classes from M2Crypto library
from M2Crypto import bio, rand, smime

# Make a MemoryBuffer of the message.
buf = makebuf(msg_str)

# Seed the PRNG.
Rand.load_file(&#039;randpool.dat&#039;, -1)

# Instantiate an SMIME object; set it up; sign the buffer.
s = SMIME.SMIME()
s.load_key(&#039;key.pem&#039;, &#039;cert.pem&#039;)
p7 = s.sign(buf, SMIME.PKCS7_DETACHED)

# Recreate buf.
buf = makebuf(msg_str)

# Output p7 in mail-friendly format.
out = BIO.MemoryBuffer()
out.write(&#039;From: %s\n&#039; % sender)
out.write(&#039;To: %s\n&#039; % target)
out.write(&#039;Subject: %s\n&#039; % subject)

s.write(out, p7, buf)
msg = out.read()

# Save the PRNG&#039;s state.
Rand.save_file(&#039;randpool.dat&#039;)
</pre>
<p><em>This code originates from the Python M2Crypto documentation<sup>2</sup></em></p>
<p>For the above code to work, the following files must be in the same directory as the Python script:<br />
* The public certificate saved as <em>cert.pem</em><br />
* The private key saved as <em>key.pem</em></p>
<p>There are many Certificate Authorities that allow you to obtain a certificate online. Some even allow you to request a certificate for your email address for free. A quick google query for “free email certificate” should give you enough results to start requesting your own certificate. If you have access to an inbox you’re good to go.<br />
To get an idea of how the above code snippet can be included in a standalone script, we’d like to refer to Fox-IT’s Github page where we’ve uploaded an example script which takes the most basic email parameters (‘from’, ‘to’, ‘subject’ and ‘body’). Don’t forget to place the required certificate and corresponding key file in the same directory with the Python script if you start playing around with the example script. Link to project on GitHub: <a href="https://github.com/fox-it/signed-phishing-email" rel="nofollow">https://github.com/fox-it/signed-phishing-email</a></p>
<h3>Mitigation</h3>
<p>There are some mitigations that can make this type of attack harder to perform for an attacker. We’d like to give you some tips to help protect your organisation.</p>
<h4>Prevent domain squatting</h4>
<p>The first mitigation is to register domains that look like your own domain. An attacker that sends a phishing mail from a domain name that is similar to your own domain name can trick users into executing malware or giving away their credentials more easily. This type of attack is called domain squatting, which can result in examples like fox-it.cm instead of fox-it.com . There are generators that can help you with that, such as: <a href="https://github.com/elceef/dnstwist" rel="nofollow">https://github.com/elceef/dnstwist</a></p>
<h4>Restrict Enhanced Key Usages</h4>
<p>Another mitigation has a more technical approach. For that we need to look into how certificates are used. Let’s say we have an internal Public Key Infrastructure (PKI) with the following components:<br />
* Root CA<br />
* Subordinate CA</p>
<p>The root CA is an important server in an organisation for maintaining integrity and secrecy. All non-public certificates will stem from this server. Most organizations choose to completely isolate their root CA for that reason and use another server, the subordinate CA, to sign certificate requests; The subordinate CA will sign certificates on behalf of the root CA.<br />
In Windows, the certificate of the root CA is stored in the <em>Trusted Root Certification Authorities</em> store, while the certificate of the subordinate CA is stored in the <em>Intermediate Certification Authorities</em> store.</p>
<p>Certificates can be used in many scenarios, for example:<br />
* If you want to encrypt files, you can use Encrypted File System (EFS) in Windows. EFS uses a certificate to protect your data from prying eyes.<br />
* If you have a web server, you can use a certificate to establish a secure connection with a client so that all data is transferred securely.<br />
* Stating the obvious: if you want to send email in a secure way, you can also use a certificate to achieve that</p>
<p>Not every certificate can sign code, encrypt files or send email securely. Certificates have a property, the Enhanced Key Usage (EKU), that states the intended purpose of a certificate. The intended purpose can be one of the actions mentioned above, or a wildcard. A certificate with only an EKU for code signing cannot be used to send email in a secure manner.</p>
<p>By disabling the “Secure Email” EKU from all certification authorities, except from our own root and subordinate CA, phishing mail that is signed with a valid certificate signed by a third party CA, will still trigger a warning stating that the certificate is invalid.<br />
To do that, we must first discover all certificates that support the secure email EKU. This can be done with the following PowerShell one-liner:</p>
<pre class="brush: powershell; title: ; notranslate">
# Select all certificates where the EnhancedKeyUsage is empty (Intended Purpose -eq All)
# or where EnhancedKeyUsage contains Secure Email
Get-ChildItem -Path &#039;Cert:\&#039; -Recurse | Where-Object {$_.GetType().Name -eq &#039;X509Certificate2&#039; -and ({$_.EnhancedKeyUsageList.Count -eq 0} -or $_.EnhancedKeyUsageList.FriendlyName -contains &#039;Secure Email&#039;)} | Select-Object PSParentPath, Subject
</pre>
<p>We now know which certificates support the <em>secure email</em> EKU. In order to disable to <em>secure email</em> EKU we have to do some manual labour. It is recommended to apply the following in a base image, group policy or certificate template.</p>
<ol>
<li>Run <em>mmc</em> with administrative privileges</li>
<li>Go to <strong>File</strong>, <strong>Add or Remove Snap-ins</strong>, select <strong>Certificates</strong><br />
<img data-attachment-id="2357" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/b8tqt4f/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png" data-orig-size="674,477" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="B8TQT4f" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png?w=674" class="alignnone size-full wp-image-2357" src="https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png?w=800" alt="B8TQT4f" srcset="https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png 674w, https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/B8TQT4f.png?w=300 300w" sizes="(max-width: 674px) 100vw, 674px"   /></li>
<li>Select <strong>My user account</strong>, followed by <strong>OK</strong>. Please note that this mitigation requires that certificates in <em>all</em> certificates stores must be edited.<br />
<img data-attachment-id="2358" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/cprqtrz/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png" data-orig-size="520,388" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="CpRQtRz" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png?w=520" class="alignnone size-full wp-image-2358" src="https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png?w=800" alt="CpRQtRz" srcset="https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png 520w, https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/CpRQtRz.png?w=300 300w" sizes="(max-width: 520px) 100vw, 520px"   /></p>
<ol>
<li>Check if intended purpose states <em>Secure email</em> or <em>All</em><br />
<img data-attachment-id="2356" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/175mrhh/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png" data-orig-size="608,133" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="175MRhH" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png?w=300" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png?w=608" class="alignnone size-full wp-image-2356" src="https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png?w=800" alt="175MRhH" srcset="https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png 608w, https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png?w=150 150w, https://foxitsecurity.files.wordpress.com/2018/12/175MRhH.png?w=300 300w" sizes="(max-width: 608px) 100vw, 608px"   /></li>
</ol>
</li>
<li>Open the properties of a certificate and click the <em>details</em> tab</li>
</ol>
<p>If the intended purpose at step 3.1 stated <em>All</em>,<br />
1. Click <strong>Key Usage</strong>, followed by <strong>Edit Properties</strong>.<br />
<img data-attachment-id="2360" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/ifpwv2x/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png" data-orig-size="405,515" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="iFPwV2x" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png?w=236" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png?w=405" class="alignnone size-full wp-image-2360" src="https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png?w=800" alt="iFPwV2x" srcset="https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png 405w, https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png?w=118 118w, https://foxitsecurity.files.wordpress.com/2018/12/iFPwV2x.png?w=236 236w" sizes="(max-width: 405px) 100vw, 405px"   /><br />
2. Click <strong>Enable only the following purposes</strong> and uncheck the <strong>Secure Email </strong>checkbox<br />
<img data-attachment-id="2355" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/8nhvj29/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png" data-orig-size="405,515" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="8nhvj29" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=236" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=405" class="alignnone size-full wp-image-2355" src="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=800" alt="8nhvj29" srcset="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png 405w, https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=118 118w, https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=236 236w" sizes="(max-width: 405px) 100vw, 405px"   /></p>
<p>If the intended purpose at step 3a stated <em>Secure Email</em>,<br />
1. Click <strong>Enhanded key usage (property)</strong><br />
<img data-attachment-id="2359" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/ehh4vbz/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png" data-orig-size="405,515" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="EHH4vBz" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png?w=236" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png?w=405" class="alignnone size-full wp-image-2359" src="https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png?w=800" alt="EHH4vBz" srcset="https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png 405w, https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png?w=118 118w, https://foxitsecurity.files.wordpress.com/2018/12/EHH4vBz.png?w=236 236w" sizes="(max-width: 405px) 100vw, 405px"   /><br />
2. Click <strong>Edit Properties&#8230;</strong><br />
3. Uncheck the <strong>Secure Email</strong> checkbox<br />
<img data-attachment-id="2355" data-permalink="https://blog.fox-it.com/2018/12/18/your-trust-our-signature/8nhvj29/" data-orig-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png" data-orig-size="405,515" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="8nhvj29" data-image-description="" data-medium-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=236" data-large-file="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=405" class="alignnone size-full wp-image-2355" src="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=800" alt="8nhvj29" srcset="https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png 405w, https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=118 118w, https://foxitsecurity.files.wordpress.com/2018/12/8nhvj29.png?w=236 236w" sizes="(max-width: 405px) 100vw, 405px"   /></p>
<p>Please keep the following in mind when implementing these mitigations:<br />
* When a legitimate mail has been signed with with a certificate issues by a CA that of which the <em>Secure Email</em> EKU has been removed, the certificate of the email will not be trusted by Windows<br />
* Changing the EKU may have an impact on the working of your systems<br />
* These settings can be reverted with every update in Windows<br />
* New or renewed certificates can have the <em>Secure email</em> EKU as well</p>
<p>This means that in order to only allow your own PKI server to have the <em>Secure Email</em> EKU enabled you must periodically check for certificates that have this EKU configured.</p>
<h4>Human factor</h4>
<p>With techniques like the one described in this blog post it becomes more and more obvious that users will never be able to withstand social engineering attacks. In a best case scenario, users will detect and report an attack, in a worst case scenario your users will become victim. It is important to perform awareness exercises and educate users, but we should accept that a percentage of the user base could always become a victim. This means that we (organizations) need to start thinking about new and more user friendly strategies in combating these type of attacks.</p>
<p>To summerize this blogpost:<br />
* An email coming from a domain does not prove the integrity of the sender<br />
* An email that is signed with a trusted and legitimate certificate does not mean that the email can be trusted<br />
* If the domain of the sender address is correct and the email has been signed with a valid certificate signed by a trusted CA, only then the email can be trusted.</p>
<h3>References</h3>
<p>1: <a href="https://www.rijksoverheid.nl/onderwerpen/digitale-overheid/vraag-en-antwoord/wat-is-een-elektronische-handtekening" rel="nofollow">https://www.rijksoverheid.nl/onderwerpen/digitale-overheid/vraag-en-antwoord/wat-is-een-elektronische-handtekening</a> (Dutch)<br />
2: <a href="https://m2crypto.readthedocs.io/en/latest/howto.smime.html#m2crypto-smime" rel="nofollow">https://m2crypto.readthedocs.io/en/latest/howto.smime.html#m2crypto-smime</a> &#8220;M2Crypto S/MIME&#8221;</p>
    </body>
</html>